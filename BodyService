local DEBUG = true
local function debugLog(...)
	if not DEBUG then return end
	print(...)
end

local RunService = game:GetService("RunService")

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local bodySystem = ReplicatedStorage:WaitForChild("BodySystem")

--// Modules
local Config = require(bodySystem:WaitForChild("Expie_Config"))
local BodyData = require(bodySystem:WaitForChild("BodyData"))

local Players = game:GetService("Players")

-- СОЗДАЁМ BodyState, ЕСЛИ ЕГО НЕТ

local bodyStateFolder = bodySystem:FindFirstChild("BodyState") -- от примено воооот тут
if not bodyStateFolder then
	bodyStateFolder = Instance.new("Folder")
	bodyStateFolder.Name = "BodyState"
	bodyStateFolder.Parent = bodySystem
end

Players.PlayerAdded:Connect(function(player)
	local playerFolder = Instance.new("Folder")
	playerFolder.Name = tostring(player.UserId)
	playerFolder.Parent = bodyStateFolder

	print("[BodyService] BodyState created for", player.Name) 
end)



-- хранилище тел игроков
local PlayerBodies = {}

local BodyService = {}
BodyService.__index = BodyService

BodyService.Bodies = {}



function BodyService:CreateBodyForPlayer(player)
	
	if self.Bodies[player] then
		warn("Body already exists for", player.Name)
		return
	end
	
	local body = self:CreateBody()
	
	self.Bodies[player] = body

	print("[BodyService] Body created for", player.Name)

	return body
end



function BodyService:RemoveBodyForPlayer(player)
	self.Bodies[player] = nil
	print("[BodyService] Body removed for", player.Name)
end

-- ==============================
-- СОЗДАНИЕ ТЕЛА
-- ==============================

function BodyService:CreateBody()
	local body = BodyData.new()
	for k,v in pairs(BodyService.Bodies) do -- или тут, хз если честно
		print("BODY IN SERVICE", k, v)
	end
	return body
end

-- ==============================
-- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
-- ==============================

local function clamp(value, min, max)
	return math.max(min, math.min(value, max))
end


-- ==============================
-- UPDATE BODY
-- ==============================
function BodyService:UpdateBody(body, dt) -- Вот тут у нас пиздец творится какой то, хотя не... не тут, где то чуть выше
	
	if DEBUG then
		print(string.format(
			"H: %.1f  |  T: %.1f | E: %.1f | I % 1f",
			body.Hunger,
			body.Thirst,
			body.Energy,
			body.Immunity
			))
	end
	
	
	if type(body) ~= "table" then
		warn("BODY NOT TABLE", body)
		return
	end
	
	for name, limb in pairs(body.Parts) do
		if type(limb) ~= "table" then
			warn("LIMB BROKEN", name, limb)
		end
	end
	
	-- Иммунитет
	local delta = self:CalculateImmunityDelta(body, dt)
	
	local growthFactor = 1 -
		(body.Immunity / body.MaxImmunity)
	 
	 growthFactor = math.clamp(growthFactor, 0, 1)
	 
	body.Immunity += delta * growthFactor * dt

	
	body.Immunity = math.clamp(
		body.Immunity,
		body.MinImmunity,
		body.MaxImmunity
	)
	
	-- Конечности
	for _, limb in pairs(body.Parts) do 
		self:UpdateLimbRegen(limb, dt)
	end
	
	-- Глобальные состояния
	self:UpdateGlobalStates(body, dt)
	print("Tick", body, body.Immunity)
	
end



-- ==============================
-- IMPACT 
-- ==============================


-- ==============================
-- ИММУНИТЕТ
-- ==============================

function BodyService:CalculateImmunityDelta(stats) 

	local delta = 0 

	-- ===== HUNGER =====
	if stats.Hunger > 90 then
		delta += 0.5
	elseif stats.Hunger < 40 then
		delta -= 1.2
	end

	-- ===== THIRST =====
	if stats.Thirst > 90 then
		delta += 0.4
	elseif stats.Thirst < 40 then
		delta -= 1.5
	end

	-- ===== ENERGY =====
	if stats.Energy > 80 then
		delta += 0.3
	elseif stats.Energy < 30 then
		delta -= 1
	end

	-- ===== BLOOD (ПРОЦЕНТ!) =====
	local bloodPercent = stats.Blood / stats.MaxBlood 

	if bloodPercent < 0.6 then
		delta -= 0.2
	elseif bloodPercent > 0.9 then
		delta += 0.2
	end

	-- ===== TEMPERATURE =====
	if stats.Temperature > 38 then
		delta -= 3
	elseif stats.Temperature < 35 then
		delta -= 2
	end

	-- ===== АНТИБИОТИК =====
	if stats.HasAntibiotics then
		delta += 2
	end

	return delta
end

-- ==============================
-- РЕГЕН КОЖИ/МЫШЦ
-- ==============================

local REGEN_CONFIG = {
	Skin = {
		NormalRate = 10,
		CriticalRate = 60,
		CriticalThreshold = 10, 
	},
	
	Muscle = {
		NormalRate = 10,
		CriticalRate = 60,
		CriticalThreshold = 10,
	}
}

function BodyService:UpdateLimbRegen(limb, deltaTime)

	-- SKIN
	if limb.Infection <= 0 then
		local skin = limb.Skin

		if limb.Skin < Config.Global.MAX_SKIN then
			
			limb.RegenTimer += deltaTime
			
			if limb.RegenTimer >= 1 then
				limb.RegenTimer = 0
				limb.Skin += 1
			end
		end
	end

	-- MUSCLE
	local muscle = limb.Muscle

	if limb.Muscle < Config.Global.MAX_MUSCLE then
		limb.RegenTimer += deltaTime
		
		if limb.RegenTimer >= 1 then
			limb.RegenTimer = 0
			limb.Muscle += 1
		end
	end
end

-- ==============================
-- ОБНОВЛЕНИЕ СОСТОЯНИЙ
-- ==============================
function BodyService:UpdateGlobalStates(body)
	-- смерть
	if body.Brain <= 0 then
		body.States.Dead = true
		body.States.Unconscious = true
		return
	end

	-- сознание всегда стремится к мозгу
	body.Consciousness = clamp(
		body.Consciousness,
		0,
		body.Brain
	)

	-- потеря сознания
	if body.Consciousness <= 0 then
		body.States.Unconscious = true
	elseif body.Consciousness >= 10 then
		body.States.Unconscious = false
	end
end


Players.PlayerAdded:Connect(function(player)
	BodyService:CreateBodyForPlayer(player)
end)

Players.PlayerRemoving:Connect(function(player)
	BodyService:RemoveBodyForPlayer(player)
end)

function BodyService:Start()
	
	RunService.Heartbeat:Connect(function(dt)
		for player, body in pairs(self.Bodies) do
			self:UpdateBody(body, dt)
		
		end
	end)
end

-- Старт цикла
BodyService:Start()


return BodyService 
